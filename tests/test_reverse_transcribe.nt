# primer tests:
# - stock conc set in reaction
# - name inferred from type
#
# - show stock, but no dilutions
# - show stock, able to dilute stock
# - show stock, unable to dilute stock

test_make_combos:
  -
    id: base
    group:
      members:
        -
          template: 'f1'
          include_rt: True
        -
          template: 'f2'
          include_rt: True
    reaction:
      > Reaction.from_text("""\
      > Reagent       Flags  Volume
      > ============  =====  ======
      > template RNA           1 µL
      > enzyme        RT       2 µL
      > """)
    expected:
      -
        template RNA: 'f1'
      -
        template RNA: 'f2'
  -
    id: primer
    group:
      members:
        -
          template: 'f1'
          primer: 'o1'
          primer_key: 'gene'
          reaction_prototype:
            > Reaction.from_text("""\
            > Reagent               Key   Volume  Flags
            > ====================  ====  ======  ======
            > gene-specific primer  gene    1 µL  primer
            > """)
          include_rt: True
    reaction:
      > Reaction.from_text("""\
      > Reagent       Flags  Volume
      > ============  =====  ======
      > template RNA           1 µL
      > primer                 1 µL
      > enzyme        RT       2 µL
      > """)
    expected:
      -
        template RNA: 'f1'
        primer: 'o1'
  -
    id: primer-key
    group:
      members:
        -
          template: 'f1'
          primer: None
          primer_key: 'hex'
          reaction_prototype:
            > Reaction.from_text("""\
            > Reagent          Key  Volume  Flags
            > ===============  ===  ======  ======
            > random hexamers  hex    1 µL  primer
            > """)
          include_rt: True
    reaction:
      > Reaction.from_text("""\
      > Reagent       Flags  Volume
      > ============  =====  ======
      > template RNA           1 µL
      > primer                 1 µL
      > enzyme        RT       2 µL
      > """)
    expected:
      -
        template RNA: 'f1'
        primer: 'random hexamers'
  -
    id: primer-stock
    group:
      members:
        -
          template: 'f1'
          primer: 'o1'
          primer_key: 'gene'
          reaction_prototype:
            > Reaction.from_text("""\
            > Reagent               Key   Volume  Flags
            > ====================  ====  ======  ======
            > gene-specific primer  gene    1 µL  primer 
            > """)
          include_rt: True
    reaction:
      > Reaction.from_text("""\
      > Reagent       Flags  Stock  Volume
      > ============  =====  =====  ======
      > template RNA                  1 µL
      > primer               10 µM    1 µL
      > enzyme        RT              2 µL
      > """)
    expected:
      -
        template RNA: 'f1'
        primer: 'o1'
  -
    id: primer-stock
    group:
      members:
        -
          template: 'f1'
          primer: 'o1'
          primer_key: 'gene'
          reaction_prototype:
            > Reaction.from_text("""\
            > Reagent               Key   Stock  Volume  Flags
            > ====================  ====  =====  ======  ======
            > gene-specific primer  gene  10 µM    1 µL  primer 
            > """)
          include_rt: True          
    reaction:
      > Reaction.from_text("""\
      > Reagent       Flags  Volume
      > ============  =====  ======
      > template RNA           1 µL
      > primer                 1 µL
      > enzyme        RT       2 µL
      > """)
    expected:
      -
        template RNA: 'f1'
        primer: '10 µM o1'
  -
    id: primer-stock-dilution
    group:
      members:
        -
          template: 'f1'
          primer: 'o1'
          primer_key: 'gene'
          reaction_prototype:
            > Reaction.from_text("""\
            > Reagent               Key   Stock  Volume  Flags
            > ====================  ====  =====  ======  ======
            > gene-specific primer  gene  10 µM    1 µL  primer 
            > """)
          include_rt: True          
    reaction:
      > Reaction.from_text("""\
      > Reagent       Flags  Volume
      > ============  =====  ======
      > template RNA           1 µL
      > primer                 2 µL
      > enzyme        RT       2 µL
      > """)
    expected:
      -
        template RNA: 'f1'
        primer: '5 µM o1'
  -
    id: primer-stock-dilution-cant-divide
    group:
      members:
        -
          template: 'f1'
          primer: 'o1'
          primer_key: 'gene'
          reaction_prototype:
            > Reaction.from_text("""\
            > Reagent               Key   Stock  Volume  Flags
            > ====================  ====  =====  ======  ======
            > gene-specific primer  gene   pure    1 µL  primer 
            > """)
          include_rt: True          
    reaction:
      > Reaction.from_text("""\
      > Reagent       Flags  Volume
      > ============  =====  ======
      > template RNA           1 µL
      > primer                 2 µL
      > enzyme        RT       2 µL
      > """)
    expected:
      -
        template RNA: 'f1'
        primer: 'pure o1 (diluted 2x)'
  -
    id: minus-rt
    group:
      members:
        -
          template: 'f1'
          include_rt: True
        -
          template: 'f2'
          include_rt: True
        -
          template: 'f1'
          include_rt: False
        -
          template: 'f2'
          include_rt: False
    reaction:
      > Reaction.from_text("""\
      > Reagent       Flags  Volume
      > ============  =====  ======
      > template RNA           1 µL
      > enzyme        RT       2 µL
      > """)
    expected:
      -
        template RNA: 'f1'
        enzyme: '+'
      -
        template RNA: 'f1'
        enzyme: '−'
      -
        template RNA: 'f2'
        enzyme: '+'
      -
        template RNA: 'f2'
        enzyme: '−'
  -
    id: minus-rt-names
    group:
      members:
        -
          template: 'f1'
          include_rt: True
        -
          template: 'f1'
          include_rt: False
    reaction:
      > Reaction.from_text("""\
      > Reagent       Flags  Volume
      > ============  =====  ======
      > template RNA           1 µL
      > enzyme        RT       2 µL
      > """)
    kwargs:
      rt_controls:
        - 'denatured'
        - 'active'
    expected:
      -
        template RNA: 'f1'
        enzyme: 'denatured'
      -
        template RNA: 'f1'
        enzyme: 'active'
  -
    id: minus-rt-all
    group:
      members:
        -
          template: 'f1'
          include_rt: False
        -
          template: 'f2'
          include_rt: False
    reaction:
      > Reaction.from_text("""\
      > Reagent       Flags  Volume
      > ============  =====  ======
      > template RNA           1 µL
      > enzyme        RT       2 µL
      > """)
    expected:
      -
        template RNA: 'f1'
        enzyme: 'enzyme (−)'
      -
        template RNA: 'f2'
        enzyme: 'enzyme (−)'

test_setup_template:
  -
    group:
      members:
        -
          template_stock_ng_uL: 100
        -
          template_stock_ng_uL: 200
    reaction:
      > Reaction.from_text("""\
      > Reagent           Stock    Volume
      > ============  =========  ========
      > water                    to 10 µL
      > template RNA  200 ng/µL      1 µL
      > """)
    expected: 
      > Reaction.from_text("""\
      > Reagent           Stock    Volume
      > ============  =========  ========
      > water                    to 10 µL
      > template RNA  100 ng/µL      2 µL
      > """)
  -
    group:
      members:
        -
          template_stock_ng_uL: None
        -
          template_stock_ng_uL: None
    reaction:
      > Reaction.from_text("""\
      > Reagent           Stock    Volume
      > ============  =========  ========
      > water                    to 10 µL
      > template RNA  200 ng/µL      1 µL
      > """)
    expected: 
      > Reaction.from_text("""\
      > Reagent           Stock    Volume
      > ============  =========  ========
      > water                    to 10 µL
      > template RNA  200 ng/µL      1 µL
      > """)

test_setup_primer:
  -
    id: choose-hexamers
    group:
      members:
        -
          primer_key: 'random hexamers'
    reaction:
      > Reaction.from_text("""\
      > Reagent              Stock    Volume  Flags
      > ===============  =========  ========  =======
      > water                       to 10 µL
      > template RNA     200 ng/µL      1 µL
      > oligo dT             50 µM      1 µL  primer
      > random hexamers  250 ng/µL      1 µL  primer
      > """)
    expected:
      > Reaction.from_text("""\
      > Reagent       Name                 Stock    Volume
      > ============  ===============  =========  ========
      > water                                     to 10 µL
      > template RNA                   200 ng/µL      1 µL
      > primer        random hexamers  250 ng/µL      1 µL
      > """)
  -
    id: adjust-stock
    group:
      members:
        -
          primer_key: 'gene-specific primer'
          primer_stock_uM: 2
        -
          primer_key: 'gene-specific primer'
          primer_stock_uM: 1
        -
          primer_key: 'gene-specific primer'
          primer_stock_uM: None
    reaction:
      > Reaction.from_text("""\
      > Reagent                   Stock    Volume  Flags
      > ====================  =========  ========  =======
      > water                            to 10 µL
      > template RNA          200 ng/µL      1 µL
      > oligo dT                  50 µM      1 µL  primer
      > random hexamers       250 ng/µL      1 µL  primer
      > gene-specific primer       2 µM      1 µL  primer
      > """)
    expected:
      > Reaction.from_text("""\
      > Reagent       Name                      Stock    Volume
      > ============  ====================  =========  ========
      > water                                          to 10 µL
      > template RNA                        200 ng/µL      1 µL
      > primer        gene-specific primer       1 µM      2 µL
      > """)
  -
    id: adjust-volume
    group:
      members:
        -
          primer_key: 'oligo dT'
        -
          primer_key: 'random hexamers'
    reaction:
      > Reaction.from_text("""\
      > Reagent                   Stock    Volume  Flags
      > ====================  =========  ========  =======
      > water                            to 10 µL
      > template RNA          200 ng/µL      1 µL
      > oligo dT                  50 µM      1 µL  primer
      > random hexamers       250 ng/µL      2 µL  primer
      > """)
    expected:
      > Reaction.from_text("""\
      > Reagent           Stock    Volume
      > ============  =========  ========
      > water                    to 10 µL
      > template RNA  200 ng/µL      1 µL
      > primer                       2 µL
      > """)
          
test_denature_protocol:
  -
    id: base
    group:
      key:
        reaction_prototype:
          > Reaction.from_text("""\
          > Reagent                   Stock    Volume  Flags
          > ====================  =========  ========  =======
          > water                            to 10 µL
          > SuperScript VILO             5x      2 µL  RT
          > template RNA          200 ng/µL      1 µL
          > """)
        template_stock_ng_uL: 200
        anneal: False
        denature_rt:
          -
            temp_C: 65
            time_m: 10
      members:
        -
          template: 'f1'
          include_rt: True
        -
          template: 'f1'
          include_rt: False
        -
          template: 'f2'
          include_rt: True
        -
          template: 'f2'
          include_rt: False

    expected:
      - Prepare enough reverse transcriptase (RT) master mix for 4 reactions:

      - Reagent           Stock   Volume      4.4x
      - ──────────────────────────────────────────
      - water                    7.00 µL  30.80 µL
      - SuperScript VILO     5x  2.00 µL   8.80 µL

      - Denature 19.80 µL of the RT master mix:
      - - Incubate at 65°C for 10m.

      - Setup 4 reverse transcription reactions:
      
      - - Use all combinations of the following reagents:
      -   RT master mix: denatured, non-denatured
      -   template RNA: f1, f2

      - - Setup the reactions:
      -   Reagent            Stock    Volume
      -   ──────────────────────────────────
      -   RT master mix              9.00 µL
      -   template RNA   200 ng/µL   1.00 µL
      -   ──────────────────────────────────
      -                             10.00 µL
  -
    id: unbalanced
    group:
      key:
        reaction_prototype:
          > Reaction.from_text("""\
          > Reagent                   Stock    Volume  Flags
          > ====================  =========  ========  =======
          > water                            to 10 µL
          > SuperScript VILO             5x      2 µL  RT
          > template RNA          200 ng/µL      1 µL
          > """)
        template_stock_ng_uL: 200
        anneal: False
        denature_rt:
          -
            temp_C: 65
            time_m: 10
      members:
        -
          template: 'f1'
          include_rt: True
        -
          template: 'f1'
          include_rt: False
        -
          template: 'f2'
          include_rt: True

    expected:
      - Denature 9.90 µL of the RT master mix:
  -
    id: err-anneal
    group:
      key:
        anneal: True
    error:
      type: UsageError
      message: requested both `denature` and `anneal`
  -
    id: err-primer
    group:
      key:
        reaction_prototype:
          > Reaction.from_text("""\
          > Reagent                   Stock    Volume  Flags
          > ====================  =========  ========  =======
          > water                            to 10 µL
          > SuperScript VILO             5x      2 µL  RT
          > template RNA          200 ng/µL      1 µL
          > random hexamers       250 ng/µL      1 µL  primer
          > """)
        anneal: False
    error:
      type: UsageError
      message: `denature` requested, but reaction includes primer

test_quick_reactions:
  -
    id: plus-rt
    group:
      key:
        reaction_prototype:
          > Reaction.from_text("""\
          > Reagent                          Stock    Volume  Flags
          > ===========================  =========  ========  ======
          > DEPC-treated water                      to 20 µL
          > VILO reaction mix                   5x      4 µL
          > SuperScript enzyme mix             10x      2 µL  RT
          > template RNA                 500 ng/µL      5 µL
          > """)
        template_stock_ng_uL: 500
        anneal: False
      members:
        -
          template: 'f1'
          include_rt: True
        -
          template: 'f2'
          include_rt: True

    expected:
      - Setup 2 reverse transcription reactions:
      
      - - Use the following reagents:
      -   template RNA: f1, f2

      - - Make master mix:
      -   Reagent                 Stock    Volume      2.2x
      -   ─────────────────────────────────────────────────
      -   DEPC-treated water              9.00 µL  19.80 µL
      -   VILO reaction mix          5x   4.00 µL   8.80 µL
      -   SuperScript enzyme mix    10x   2.00 µL   4.40 µL
      -   ─────────────────────────────────────────────────
      -                                  15.00 µL  33.00 µL

      - - Setup the reactions:
      -   Reagent           Stock    Volume
      -   ─────────────────────────────────
      -   master mix               15.00 µL
      -   template RNA  500 ng/µL   5.00 µL
      -   ─────────────────────────────────
      -                            20.00 µL
  -
    id: minus-rt
    group:
      key:
        reaction_prototype:
          > Reaction.from_text("""\
          > Reagent                          Stock    Volume  Flags
          > ===========================  =========  ========  ======
          > DEPC-treated water                      to 20 µL
          > VILO reaction mix                   5x      4 µL
          > SuperScript enzyme mix             10x      2 µL  RT
          > template RNA                 500 ng/µL      5 µL
          > """)
        template_stock_ng_uL: 500
        anneal: False
      members:
        -
          template: 'f1'
          include_rt: True
        -
          template: 'f1'
          include_rt: False
        -
          template: 'f2'
          include_rt: True
        -
          template: 'f2'
          include_rt: False

    expected:
      - Setup 4 reverse transcription reactions:
      
      - - Use all combinations of the following reagents:
      -   SuperScript enzyme mix: +, −
      -   template RNA: f1, f2

      - - Make master mix:
      -   Reagent             Stock    Volume     ≈4.8x
      -   ─────────────────────────────────────────────
      -   DEPC-treated water          9.00 µL  43.56 µL
      -   VILO reaction mix      5x   4.00 µL  19.36 µL
      -   ─────────────────────────────────────────────
      -                              13.00 µL  62.92 µL

      - - Make 2 RT mixes:
      -   Reagent                 Stock    Volume      2.2x
      -   ─────────────────────────────────────────────────
      -   master mix                     13.00 µL  28.60 µL
      -   SuperScript enzyme mix    10x   2.00 µL   4.40 µL
      -   ─────────────────────────────────────────────────
      -                                  15.00 µL  33.00 µL

      - - Setup the reactions:
      -   Reagent           Stock    Volume
      -   ─────────────────────────────────
      -   RT mix                   15.00 µL
      -   template RNA  500 ng/µL   5.00 µL
      -   ─────────────────────────────────
      -                            20.00 µL

test_standard_protocol:
  -
    id: base
    group:
      key:
        reaction_prototype:
          > Reaction.from_text("""\
          > Reagent                   Stock    Volume  Flags
          > ====================  =========  ========  =============
          > water                            to 20 µL
          > oligo(dT)₂₀               50 µM      1 µL  anneal,primer
          > random hexamers       250 ng/µL      1 µL  anneal,primer
          > gene-specific primer       2 µM      1 µL  anneal,primer
          > template RNA          500 ng/µL      5 µL  anneal
          > dNTP mix                  10 mM      1 µL  anneal
          > first-strand buffer          5x      4 µL
          > DTT                      100 mM      1 µL
          > RNaseOUT                40 U/µL      1 µL
          > SuperScript III RT     200 U/µL      1 µL  RT
          > """)
        template_stock_ng_uL: 500
        anneal: True
        anneal_volume: None
        anneal_incubation:
          -
            temp_C: 65
            time_m: 5
      members:
        -
          template: 'f1'
          primer: None
          primer_key: 'oligo(dT)₂₀'
          primer_stock_uM: None
          include_rt: True
        -
          template: 'f2'
          primer: None
          primer_key: 'oligo(dT)₂₀'
          primer_stock_uM: None
          include_rt: True

    expected:
      - Setup 2 primer-annealing reactions:
      
      - - Use the following reagents:
      -   template RNA: f1, f2

      - - Make 2x master mix:
      -   Reagent      Stock   Volume      2.2x
      -   ─────────────────────────────────────
      -   water               3.00 µL   6.60 µL
      -   oligo(dT)₂₀  50 µM  1.00 µL   2.20 µL
      -   dNTP mix     10 mM  1.00 µL   2.20 µL
      -   ─────────────────────────────────────
      -                       5.00 µL  11.00 µL

      - - Setup the reactions:
      -   Reagent           Stock    Volume
      -   ─────────────────────────────────
      -   master mix           2x   5.00 µL
      -   template RNA  500 ng/µL   5.00 µL
      -   ─────────────────────────────────
      -                            10.00 µL

      - Run the following thermocycler protocol:
      - - 65°C for 5m

      - Setup 2 reverse transcription reactions:
      -
      - - Make 2x master mix:
      -   Reagent                 Stock    Volume      2.2x
      -   ─────────────────────────────────────────────────
      -   water                           3.00 µL   6.60 µL
      -   first-strand buffer        5x   4.00 µL   8.80 µL
      -   DTT                    100 mM   1.00 µL   2.20 µL
      -   RNaseOUT              40 U/µL   1.00 µL   2.20 µL
      -   SuperScript III RT   200 U/µL   1.00 µL   2.20 µL
      -   ─────────────────────────────────────────────────
      -                                  10.00 µL  22.00 µL

      - - Setup the reactions:
      -   Reagent                   Stock    Volume
      -   ─────────────────────────────────────────
      -   master mix                   2x  10.00 µL
      -   annealed template/primer         10.00 µL
      -   ─────────────────────────────────────────
      -                                    20.00 µL
  -
    id: anneal-volume
    group:
      key:
        reaction_prototype:
          > Reaction.from_text("""\
          > Reagent                   Stock    Volume  Flags
          > ====================  =========  ========  =============
          > water                            to 20 µL
          > oligo(dT)₂₀               50 µM      1 µL  anneal,primer
          > random hexamers       250 ng/µL      1 µL  anneal,primer
          > gene-specific primer       2 µM      1 µL  anneal,primer
          > template RNA          500 ng/µL      5 µL  anneal
          > dNTP mix                  10 mM      1 µL  anneal
          > first-strand buffer          5x      4 µL
          > DTT                      100 mM      1 µL
          > RNaseOUT                40 U/µL      1 µL
          > SuperScript III RT     200 U/µL      1 µL  RT
          > """)
        template_stock_ng_uL: 500
        anneal: True
        anneal_volume: 8
        anneal_incubation:
          -
            temp_C: 65
            time_m: 5
      members:
        -
          template: 'f1'
          primer: None
          primer_key: 'oligo(dT)₂₀'
          primer_stock_uM: None
          include_rt: True
        -
          template: 'f2'
          primer: None
          primer_key: 'oligo(dT)₂₀'
          primer_stock_uM: None
          include_rt: True

    expected:
      - Setup 2 primer-annealing reactions:
      
      - - Use the following reagents:
      -   template RNA: f1, f2

      - - Make master mix:
      -   Reagent      Stock   Volume     2.2x
      -   ────────────────────────────────────
      -   water               1.00 µL  2.20 µL
      -   oligo(dT)₂₀  50 µM  1.00 µL  2.20 µL
      -   dNTP mix     10 mM  1.00 µL  2.20 µL
      -   ────────────────────────────────────
      -                       3.00 µL  6.60 µL

      - - Setup the reactions:
      -   Reagent           Stock   Volume
      -   ────────────────────────────────
      -   master mix               3.00 µL
      -   template RNA  500 ng/µL  5.00 µL
      -   ────────────────────────────────
      -                            8.00 µL

      - Run the following thermocycler protocol:
      - - 65°C for 5m

      - Setup 2 reverse transcription reactions:
      -
      - - Make master mix:
      -   Reagent                 Stock    Volume      2.2x
      -   ─────────────────────────────────────────────────
      -   water                           5.00 µL  11.00 µL
      -   first-strand buffer        5x   4.00 µL   8.80 µL
      -   DTT                    100 mM   1.00 µL   2.20 µL
      -   RNaseOUT              40 U/µL   1.00 µL   2.20 µL
      -   SuperScript III RT   200 U/µL   1.00 µL   2.20 µL
      -   ─────────────────────────────────────────────────
      -                                  12.00 µL  26.40 µL

      - - Setup the reactions:
      -   Reagent                     Volume
      -   ──────────────────────────────────
      -   master mix                12.00 µL
      -   annealed template/primer   8.00 µL
      -   ──────────────────────────────────
      -                             20.00 µL
  -
    id: minus-rt
    group:
      key:
        reaction_prototype:
          > Reaction.from_text("""\
          > Reagent                   Stock    Volume  Flags
          > ====================  =========  ========  =============
          > water                            to 20 µL
          > oligo(dT)₂₀               50 µM      1 µL  anneal,primer
          > random hexamers       250 ng/µL      1 µL  anneal,primer
          > gene-specific primer       2 µM      1 µL  anneal,primer
          > template RNA          500 ng/µL      5 µL  anneal
          > dNTP mix                  10 mM      1 µL  anneal
          > first-strand buffer          5x      4 µL
          > DTT                      100 mM      1 µL
          > RNaseOUT                40 U/µL      1 µL
          > SuperScript III RT     200 U/µL      1 µL  RT
          > """)
        template_stock_ng_uL: 500
        anneal: True
        anneal_volume: None
        anneal_incubation:
          -
            temp_C: 65
            time_m: 5
      members:
        -
          template: 'f1'
          primer: None
          primer_key: 'oligo(dT)₂₀'
          primer_stock_uM: None
          include_rt: True
        -
          template: 'f1'
          primer: None
          primer_key: 'oligo(dT)₂₀'
          primer_stock_uM: None
          include_rt: False
        -
          template: 'f2'
          primer: None
          primer_key: 'oligo(dT)₂₀'
          primer_stock_uM: None
          include_rt: True
        -
          template: 'f2'
          primer: None
          primer_key: 'oligo(dT)₂₀'
          primer_stock_uM: None
          include_rt: False

    expected:
      - Setup 2 primer-annealing reactions:
      
      - - Use the following reagents:
      -   template RNA: f1, f2

      - - Make 2x master mix:
      -   Reagent      Stock   Volume     ≈4.8x
      -   ─────────────────────────────────────
      -   water               3.00 µL  14.52 µL
      -   oligo(dT)₂₀  50 µM  1.00 µL   4.84 µL
      -   dNTP mix     10 mM  1.00 µL   4.84 µL
      -   ─────────────────────────────────────
      -                       5.00 µL  24.20 µL

      - - Setup the reactions:
      -   Reagent           Stock    Volume      2.2x
      -   ───────────────────────────────────────────
      -   master mix           2x   5.00 µL  11.00 µL
      -   template RNA  500 ng/µL   5.00 µL  11.00 µL
      -   ───────────────────────────────────────────
      -                            10.00 µL  22.00 µL

      - Run the following thermocycler protocol:
      - - 65°C for 5m

      - Setup 4 reverse transcription reactions:

      - - Setup each reaction with and without reverse transcriptase.

      - - Make master mix:
      -   Reagent                Stock   Volume     ≈4.8x
      -   ───────────────────────────────────────────────
      -   water                         3.00 µL  14.52 µL
      -   first-strand buffer       5x  4.00 µL  19.36 µL
      -   DTT                   100 mM  1.00 µL   4.84 µL
      -   RNaseOUT             40 U/µL  1.00 µL   4.84 µL
      -   ───────────────────────────────────────────────
      -                                 9.00 µL  43.56 µL

      - - Make 2 2x SuperScript III RT mixes:
      -   Reagent                Stock    Volume      2.2x
      -   ────────────────────────────────────────────────
      -   master mix                     9.00 µL  19.80 µL
      -   SuperScript III RT  200 U/µL   1.00 µL   2.20 µL
      -   ────────────────────────────────────────────────
      -                                 10.00 µL  22.00 µL

      - - Setup the reactions:
      -   Reagent                   Stock    Volume
      -   ─────────────────────────────────────────
      -   SuperScript III RT mix       2x  10.00 µL
      -   annealed template/primer         10.00 µL
      -   ─────────────────────────────────────────
      -                                    20.00 µL
  -
    id: 2-primers-1-template
    group:
      key:
        reaction_prototype:
          > Reaction.from_text("""\
          > Reagent                   Stock    Volume  Flags
          > ====================  =========  ========  =============
          > water                            to 20 µL
          > oligo(dT)₂₀               50 µM      1 µL  anneal,primer
          > random hexamers       250 ng/µL      1 µL  anneal,primer
          > gene-specific primer       2 µM      1 µL  anneal,primer
          > template RNA          500 ng/µL      5 µL  anneal
          > dNTP mix                  10 mM      1 µL  anneal
          > first-strand buffer          5x      4 µL
          > DTT                      100 mM      1 µL
          > RNaseOUT                40 U/µL      1 µL
          > SuperScript III RT     200 U/µL      1 µL  RT
          > """)
        template_stock_ng_uL: 500
        anneal: True
        anneal_volume: None
        anneal_incubation:
          -
            temp_C: 65
            time_m: 5
      members:
        -
          template: 'f1'
          primer: 'o1'
          primer_key: 'gene-specific primer'
          primer_stock_uM: None
          include_rt: True
        -
          template: 'f1'
          primer: 'o2'
          primer_key: 'gene-specific primer'
          primer_stock_uM: None
          include_rt: True

    expected:
      - Setup 2 primer-annealing reactions:
      
      - - Use the following reagents:
      -   gene-specific primer: o1, o2

      - - Make master mix:
      -   Reagent       Stock   Volume      2.2x
      -   ──────────────────────────────────────
      -   water                3.00 µL   6.60 µL
      -   f1        500 ng/µL  5.00 µL  11.00 µL
      -   dNTP mix      10 mM  1.00 µL   2.20 µL
      -   ──────────────────────────────────────
      -                        9.00 µL  19.80 µL

      - - Setup the reactions:
      -   Reagent               Stock    Volume
      -   ─────────────────────────────────────
      -   master mix                    9.00 µL
      -   gene-specific primer   2 µM   1.00 µL
      -   ─────────────────────────────────────
      -                                10.00 µL

      - Run the following thermocycler protocol:
      - - 65°C for 5m

      - Setup 2 reverse transcription reactions:
      -
      - - Make 2x master mix:
      -   Reagent                 Stock    Volume      2.2x
      -   ─────────────────────────────────────────────────
      -   water                           3.00 µL   6.60 µL
      -   first-strand buffer        5x   4.00 µL   8.80 µL
      -   DTT                    100 mM   1.00 µL   2.20 µL
      -   RNaseOUT              40 U/µL   1.00 µL   2.20 µL
      -   SuperScript III RT   200 U/µL   1.00 µL   2.20 µL
      -   ─────────────────────────────────────────────────
      -                                  10.00 µL  22.00 µL

      - - Setup the reactions:
      -   Reagent                   Stock    Volume
      -   ─────────────────────────────────────────
      -   master mix                   2x  10.00 µL
      -   annealed template/primer         10.00 µL
      -   ─────────────────────────────────────────
      -                                    20.00 µL
  -
    id: 2-primers-2-templates
    group:
      key:
        reaction_prototype:
          > Reaction.from_text("""\
          > Reagent                   Stock    Volume  Flags
          > ====================  =========  ========  =============
          > water                            to 20 µL
          > oligo(dT)₂₀               50 µM      1 µL  anneal,primer
          > random hexamers       250 ng/µL      1 µL  anneal,primer
          > gene-specific primer       2 µM      1 µL  anneal,primer
          > template RNA          500 ng/µL      5 µL  anneal
          > dNTP mix                  10 mM      1 µL  anneal
          > first-strand buffer          5x      4 µL
          > DTT                      100 mM      1 µL
          > RNaseOUT                40 U/µL      1 µL
          > SuperScript III RT     200 U/µL      1 µL  RT
          > """)
        template_stock_ng_uL: 500
        anneal: True
        anneal_volume: None
        anneal_incubation:
          -
            temp_C: 65
            time_m: 5
      members:
        -
          template: 'f1'
          primer: 'o1'
          primer_key: 'gene-specific primer'
          primer_stock_uM: None
          include_rt: True
        -
          template: 'f2'
          primer: 'o1'
          primer_key: 'gene-specific primer'
          primer_stock_uM: None
          include_rt: True
        -
          template: 'f1'
          primer: 'o2'
          primer_key: 'gene-specific primer'
          primer_stock_uM: None
          include_rt: True
        -
          template: 'f2'
          primer: 'o2'
          primer_key: 'gene-specific primer'
          primer_stock_uM: None
          include_rt: True

    expected:
      - Setup 4 primer-annealing reactions:
      
      - - Use all combinations of the following reagents:
      -   gene-specific primer: o1, o2
      -   template RNA: f1, f2

      - - Make master mix:
      -   Reagent   Stock   Volume     ≈4.8x
      -   ──────────────────────────────────
      -   water            3.00 µL  14.52 µL
      -   dNTP mix  10 mM  1.00 µL   4.84 µL
      -   ──────────────────────────────────
      -                    4.00 µL  19.36 µL

      - - Make 2 2x gene-specific primer mixes:

      -   Reagent               Stock   Volume      2.2x
      -   ──────────────────────────────────────────────
      -   master mix                   4.00 µL   8.80 µL
      -   gene-specific primer   2 µM  1.00 µL   2.20 µL
      -   ──────────────────────────────────────────────
      -                                5.00 µL  11.00 µL

      - - Setup the reactions:
      -   Reagent                       Stock    Volume
      -   ─────────────────────────────────────────────
      -   gene-specific primer mix         2x   5.00 µL
      -   template RNA              500 ng/µL   5.00 µL
      -   ─────────────────────────────────────────────
      -                                        10.00 µL

      - Run the following thermocycler protocol:
      - - 65°C for 5m

      - Setup 4 reverse transcription reactions:
      -
      - - Make 2x master mix:
      -   Reagent                 Stock    Volume      4.4x
      -   ─────────────────────────────────────────────────
      -   water                           3.00 µL  13.20 µL
      -   first-strand buffer        5x   4.00 µL  17.60 µL
      -   DTT                    100 mM   1.00 µL   4.40 µL
      -   RNaseOUT              40 U/µL   1.00 µL   4.40 µL
      -   SuperScript III RT   200 U/µL   1.00 µL   4.40 µL
      -   ─────────────────────────────────────────────────
      -                                  10.00 µL  44.00 µL

      - - Setup the reactions:
      -   Reagent                   Stock    Volume
      -   ─────────────────────────────────────────
      -   master mix                   2x  10.00 µL
      -   annealed template/primer         10.00 µL
      -   ─────────────────────────────────────────
      -                                    20.00 µL
  -
    id: err-no-flags
    group:
      key:
        reaction_prototype:
          > Reaction.from_text("""\
          > Reagent                   Stock    Volume  Flags
          > ====================  =========  ========  =======
          > water                            to 10 µL
          > SuperScript VILO             5x      2 µL  RT
          > template RNA          200 ng/µL      1 µL
          > """)
    error:
      type: UsageError
      message: `anneal` requested, but not supported for the chosen reaction

test_incubation:
  -
    id: base
    group:
      key:
        reaction_prototype: None
        incubation:
          -
            temp_C: 25
            time_m: 10
          -
            temp_C: 42
            time_m: 60
          -
            temp_C: 85
            time_m: 5
        incubation_by_primer:
          {}
    expected:
      - Run the following thermocycler protocol:
      - - 25°C for 10m
      - - 42°C for 60m
      - - 85°C for 5m
  -
    id: by-primer
    group:
      key:
        reaction_prototype:
          > Reaction.from_text("""\
          > Reagent               Key      Stock    Volume  Flags
          > ====================  ===  =========  ========  =============
          > water                                 to 20 µL
          > oligo(dT)₂₀           dt       50 µM      1 µL  anneal,primer
          > random hexamers       hex  250 ng/µL      1 µL  anneal,primer
          > gene-specific primer            2 µM      1 µL  anneal,primer
          > template RNA               500 ng/µL      5 µL  anneal
          > dNTP mix                       10 mM      1 µL  anneal
          > first-strand buffer               5x      4 µL
          > DTT                           100 mM      1 µL
          > RNaseOUT                     40 U/µL      1 µL
          > SuperScript III RT          200 U/µL      1 µL  RT
          > """)
        primer_key: 'hex'
        incubation:
          dt:
            -
              temp_C: 50
              time_m: 60
            -
              temp_C: 85
              time_m: 5
        incubation_by_primer:
          hex:
            -
              temp_C: 25
              time_m: 10
            -
              temp_C: 42
              time_m: 60
            -
              temp_C: 85
              time_m: 5
    expected:
      > 1. Run the following thermocycler protocol:
      >
      >    - 25°C for 10m
      >    - 42°C for 60m
      >    - 85°C for 5m
  -
    id: diff-primers
    group:
      key:
        reaction_prototype:
          > Reaction.from_text("""\
          > Reagent               Key      Stock    Volume  Flags
          > ====================  ===  =========  ========  =============
          > water                                 to 20 µL
          > oligo(dT)₂₀           dt       50 µM      1 µL  anneal,primer
          > random hexamers       hex  250 ng/µL      1 µL  anneal,primer
          > gene-specific primer            2 µM      1 µL  anneal,primer
          > template RNA               500 ng/µL      5 µL  anneal
          > dNTP mix                       10 mM      1 µL  anneal
          > first-strand buffer               5x      4 µL
          > DTT                           100 mM      1 µL
          > RNaseOUT                     40 U/µL      1 µL
          > SuperScript III RT          200 U/µL      1 µL  RT
          > """)
        primer_aliases:
          dt: 'oligo(dT)₂₀'
          hex: 'random hexamers'
        incubation:
          -
            temp_C: 50
            time_m: 60
          -
            temp_C: 85
            time_m: 5
        incubation_by_primer:
          hex:
            -
              temp_C: 25
              time_m: 10
            -
              temp_C: 42
              time_m: 60
            -
              temp_C: 85
              time_m: 5
      members:
        -
          primer_key: 'dt'
        -
          primer_key: 'hex'
        -
          primer_key: 'hex'

    expected:
      > 1. Run the following thermocycler protocols:
      >
      >    For the oligo(dT)₂₀ reaction:
      >
      >    - 50°C for 60m
      >    - 85°C for 5m
      >
      >    For the random hexamers reactions:
      >
      >    - 25°C for 10m
      >    - 42°C for 60m
      >    - 85°C for 5m

test_protocol:
  -
    id: incubation-by-primer
    app:
      > Sample = ReverseTranscribe.partial(
      >     preset='thermo/superscript-iii',
      >     primer='hex',
      > )
      > app = ReverseTranscribeCli([
      >     Sample('f1'),
      >     Sample('f2'),
      > ])
    expected:
      - SuperScript III RT
      - Run the following thermocycler protocol:
      - 25°C for 5m
      - 50°C for 60m
      - 85°C for 5m
  -
    id: dnase
    app:
      > Sample = ReverseTranscribe.partial(
      >     preset='thermo/superscript-iv/vilo'
      > )
      > app = ReverseTranscribeCli([
      >     Sample('f1'),
      >     Sample('f2'),
      > ])
    expected:
      > 1. Setup 2 DNase reactions:
      >
      >    - Use the following reagents:
      >
      >      RNA: f1, f2
      >
      >    - Make 2x master mix:
      >
      >      Reagent              Stock   Volume      2.2x
      >      ─────────────────────────────────────────────
      >      nuclease-free water         3.00 µL   6.60 µL
      >      ezDNase buffer         10x  1.00 µL   2.20 µL
      >      ezDNase enzyme         10x  1.00 µL   2.20 µL
      >      ─────────────────────────────────────────────
      >                                  5.00 µL  11.00 µL
      >
      >    - Setup the reactions:
      >
      >      Reagent         Stock    Volume
      >      ───────────────────────────────
      >      master mix         2x   5.00 µL
      >      RNA         500 ng/µL   5.00 µL
      >      ───────────────────────────────
      >                             10.00 µL
      >
      > 2. Incubate at 37°C for 2m.
      >
      > 3. Setup 2 reverse transcription reactions:
      >
      >    - Use the following reagents:
      >
      >      DNase-treated template RNA: f1, f2
      >
      >    - Make 2x master mix:
      >
      >      Reagent              Stock    Volume      2.2x
      >      ──────────────────────────────────────────────
      >      nuclease-free water          6.00 µL  13.20 µL
      >      SuperScript IV VILO     5x   4.00 µL   8.80 µL
      >      ──────────────────────────────────────────────
      >                                  10.00 µL  22.00 µL
      >
      >    - Setup the reactions:
      >
      >      Reagent                     Stock    Volume
      >      ───────────────────────────────────────────
      >      master mix                     2x  10.00 µL
      >      DNase-treated template RNA         10.00 µL
      >      ───────────────────────────────────────────
      >                                         20.00 µL
      >
      > 4. Run the following thermocycler protocol:
      >
      >    - 25°C for 10m
      >    - 42°C for 60m
      >    - 85°C for 5m

test_cli:
  -
    id: base
    cmd: sw reverse_transcribe a b c
    stdout:
      > {DATE}
      >
      > \$ sw reverse_transcribe a b c
      >
      > 1. Setup 3 reverse transcription reactions:
      >
      >    - Use the following reagents:
      >
      >      template RNA: a, b, c
      >
      >    - Make master mix:
      >
      >      Reagent                Stock    Volume      3.3x
      >      ────────────────────────────────────────────────
      >      DEPC-treated water             6.00 µL  19.80 µL
      >      oligo\(dT\)₂₀            50 µM   1.00 µL   3.30 µL
      >      dNTP mix               10 mM   1.00 µL   3.30 µL
      >      SSIV buffer               5x   4.00 µL  13.20 µL
      >      DTT                   100 mM   1.00 µL   3.30 µL
      >      RNaseOUT             40 U/µL   1.00 µL   3.30 µL
      >      SuperScript IV RT   200 U/µL   1.00 µL   3.30 µL
      >      ────────────────────────────────────────────────
      >                                    15.00 µL  49.50 µL
      >
      >    - Setup the reactions:
      >
      >      Reagent           Stock    Volume
      >      ─────────────────────────────────
      >      master mix               15.00 µL
      >      template RNA  500 ng/µL   5.00 µL
      >      ─────────────────────────────────
      >                               20.00 µL
      >
      > 2. Run the following thermocycler protocol:
      >
      >    - 50°C for 10m
      >    - 80°C for 10m
  -
    id: no-rt-control
    cmd: sw reverse_transcribe a b c -R
    stdout:
      > {DATE}
      >
      > \$ sw reverse_transcribe a b c -R
      >
      > 1. Setup 6 reverse transcription reactions:
      >
      >    - Use all combinations of the following reagents:
      >
      >      template RNA: a, b, c
      >      SuperScript IV RT: \+, −
      >
      >    - Make master mix:
      >
      >      Reagent               Stock    Volume      ≈7.3x
      >      ────────────────────────────────────────────────
      >      DEPC-treated water            6.00 µL   43.56 µL
      >      oligo\(dT\)₂₀           50 µM   1.00 µL    7.26 µL
      >      dNTP mix              10 mM   1.00 µL    7.26 µL
      >      SSIV buffer              5x   4.00 µL   29.04 µL
      >      DTT                  100 mM   1.00 µL    7.26 µL
      >      RNaseOUT            40 U/µL   1.00 µL    7.26 µL
      >      ────────────────────────────────────────────────
      >                                   14.00 µL  101.64 µL
      >
      >    - Make 2 RT mixes:
      >
      >      Reagent               Stock    Volume      3.3x
      >      ───────────────────────────────────────────────
      >      master mix                   14.00 µL  46.20 µL
      >      SuperScript IV RT  200 U/µL   1.00 µL   3.30 µL
      >      ───────────────────────────────────────────────
      >                                   15.00 µL  49.50 µL
      >
      >    - Setup the reactions:
      >
      >      Reagent           Stock    Volume
      >      ─────────────────────────────────
      >      RT mix                   15.00 µL
      >      template RNA  500 ng/µL   5.00 µL
      >      ─────────────────────────────────
      >                               20.00 µL
      >
      > 2. Run the following thermocycler protocol:
      >
      >    - 50°C for 10m
      >    - 80°C for 10m
  -
    id: thermo-superscript-iii-vilo
    cmd: sw reverse_transcribe a b c -p thermo/superscript-iii/vilo/master-mix
    stdout:
      > {DATE}
      >
      > \$ sw reverse_transcribe a b c -p thermo/superscript-iii/vilo/master-mix
      >
      > 1. Setup 3 reverse transcription reactions:
      >
      >    - Use the following reagents:
      >
      >      template RNA: a, b, c
      >
      >    - Make master mix:
      >
      >      Reagent                      Stock    Volume      3.3x
      >      ──────────────────────────────────────────────────────
      >      DEPC-treated water                  11.00 µL  36.30 µL
      >      SuperScript VILO master mix     5x   4.00 µL  13.20 µL
      >      ──────────────────────────────────────────────────────
      >                                          15.00 µL  49.50 µL
      >
      >    - Setup the reactions:
      >
      >      Reagent           Stock    Volume
      >      ─────────────────────────────────
      >      master mix               15.00 µL
      >      template RNA  500 ng/µL   5.00 µL
      >      ─────────────────────────────────
      >                               20.00 µL
      >
      > 2. Run the following thermocycler protocol:
      >
      >    - 25°C for 10m
      >    - 42°C for 60m
      >    - 85°C for 5m
  -
    id: thermo-superscript-iii-vilo-no-rt-control
    cmd: sw reverse_transcribe a b c -p thermo/superscript-iii/vilo/master-mix -R
    stdout:
      > {DATE}
      >
      > \$ sw reverse_transcribe a b c -p thermo/superscript-iii/vilo/master-mix -R
      >
      > 1. Prepare enough reverse transcriptase \(RT\) master
      >    mix for 6 reactions:
      >
      >    Reagent                      Stock    Volume      6.6x
      >    ──────────────────────────────────────────────────────
      >    DEPC-treated water                  11.00 µL  72.60 µL
      >    SuperScript VILO master mix     5x   4.00 µL  26.40 µL
      >
      > 2. Denature 49.50 µL of the RT master mix:
      >
      >    - Incubate at 65°C for 10m.
      >
      > 3. Setup 6 reverse transcription reactions:
      >
      >    - Use all combinations of the following reagents:
      >
      >      RT master mix: denatured, non-denatured
      >      template RNA: a, b, c
      >
      >    - Setup the reactions:
      >
      >      Reagent            Stock    Volume
      >      ──────────────────────────────────
      >      RT master mix             15.00 µL
      >      template RNA   500 ng/µL   5.00 µL
      >      ──────────────────────────────────
      >                                20.00 µL
      >
      > 4. Run the following thermocycler protocol:
      >
      >    - 25°C for 10m
      >    - 42°C for 60m
      >    - 85°C for 5m
